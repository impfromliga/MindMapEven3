<meta charset="utf-8">
<body>
    <style>
        #wrapper{text-align: center; position: absolute; width:100%}
        #statusbar{
            position:relative; z-index: 2; top:0px; height:20px;
            color:rgba(255,255,255,.33);
            -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none;
        }
        .prop{width:50%;float:left;background: #444; margin-top: 1px;}
        .val{width:50%;float:left;background: #444;border: 1px solid #666; margin-top: 1px;}
        #box{
            display:none;
            position:relative; z-index: 10; top:0px; width:30%; height:50px; margin: auto; padding: 8px;
            background: #444; border: 1px solid #666; box-shadow: 0px 0px 8px}
        #cnv{position:relative; top:0px; background: #444; text-rendering: optimizeSpeed; image-rendering: optimizeSpeed}
        body{background: #303030; text-align: center; margin: 0px;overflow: hidden}
    </style>
    <div id=wrapper>
        <div id=statusbar><small>наведите мышь на пункт, что бы просмотреть его описание</small></div>
        <div id=box>
            <span class=prop>Добавить дочернее имя:</span> <input class=val id=child type=text></input>
            <span class=prop>Имя текущего элемента:</span> <input class=val id=node type=text></input>
        </div>
    </div>
    <canvas id=cnv></canvas>
    <script src='mmap.json'></script>
    <script src='mmap.js'></script>
    <script src='even3.js'></script>
    <script>
        "use strict";
        //var size = Math.min(innerWidth, innerHeight)
        //cnv.width = size; cnv.height = size;
        cnv.width = innerWidth; cnv.height = innerHeight;
        var mmap = MindMap(json, {canvas:cnv,box:document.getElementById('box'),node:document.getElementById('node'),child:document.getElementById('child')});
        mmap.fillStyle = '#000'; mmap.strokeStyle = '#666';
        var debugtime = (new Date()).getTime();
        mmap.font = '16px sans-serif';
        document.title = 'карта построена за '+ ((new Date()).getTime() - debugtime)+'ms';
        go();
        function go(){
            mmap.clearRect(-cnv.width,-cnv.height,cnv.width*2,cnv.height*2);
            mmap.draw();
            window.requestAnimationFrame(go);
            //setTimeout(go,500);
            //json[0].a+=.003;
        }
        
        Even3(document.getElementById('cnv'))(
            [{mousemove: function(e){
                console.log('Hover');
                var item = mmap.pick(e.pageX - cnv.offsetLeft, e.pageY - cnv.offsetTop)
                document.getElementById('statusbar').innerHTML = item ?
                    '<b><big>"' + item[0].cap + '":</big></b> ' + (item[0].alt || 'no tip') :
                    '<small>наведите мышь на пункт, что бы просмотреть его описание</small>';
            }}],
            [{mousedown: function(e){console.log('Down');mmap.sel.opt(); mmap.sel.xor(mmap.pick(e.pageX -cnv.offsetLeft, e.pageY -cnv.offsetTop))}},
                [{wait: function(e, msg){console.log('hold...', msg.dT); if(msg.dT < 700) return true; console.log('Hold'); mmap.sel.set(false);}}],
                [{wait: function(e, msg){
                    return(Math.hypot(msg.dX, msg.dY) < 8||mmap.sel.add(mmap.pick(msg.x -cnv.offsetLeft, msg.y -cnv.offsetTop)) )-1;
                }},
                    [{mousemove: function(e, msg){console.log('Drag'); return true;}}],
                    [{mouseup: function(e, msg){console.log('Drop'); mmap.sel.mov(mmap.pick(e.pageX -cnv.offsetLeft, e.pageY -cnv.offsetTop))}}]
                ],
                [{mouseup: function(e){console.log('Click');}},
                    [{wait: function(e, msg){return ((Math.hypot(msg.dX, msg.dY) < 8) && (msg.dT < 300))||console.log('Dbl break by time/drag');}}],
                    [{mousedown: function(e,msg){console.log('DblDown');mmap.sel.xor(mmap.pick(msg.x -cnv.offsetLeft, msg.y -cnv.offsetTop))}},
                        [{wait: function(e, msg){return -(Math.hypot(msg.dX, msg.dY) > 8)}},
                            [{mousemove: function(e, msg){console.log('DblDrag'); mmap.scroll(msg.dx, msg.dy); return true;}}],
                            [{mouseup: function(){console.log('DblDrop')}}]
                        ],
                        [{mouseup: function(e, m){console.log('DblClick');mmap.sel.opt(mmap.pick(m.x -cnv.offsetLeft, m.y -cnv.offsetTop));}}]
                    ]
                ]
            ]
        )
        /*
        var KEY = {
            DEL: 46,
        }
        onkeydown = function(e){
            e = e || window.event;
            console.log(e.keyCode)
            switch(e.keyCode){
                case KEY.DEL:
                    mmap.sel.del(mmap.sel.get()[0]);
            }
        }*/
        setInterval(document.getElementById('cnv').onwait, 50);
/*[{sel:1,"cap": "mouseDn"},
    [{"cap": "mouseUp"},
        [{"cap": "mouseDn"},
            [{"cap": "mouseUp", "alt": "вход в пункт - двойной клик без задержек"}],
            [{"cap": "mouseMov", "alt": "перемещение карты - двойной клик с удержанием второго клика + перемещение (как перемещение на тайчпаде)"}]
        ],
        [{"cap": "wait", "alt": "выбор пункта - одиночный короткий клик (с контрольной ожидающей паузой, чтобы отличить от возможного двойного)"}]
    ],
    [{"cap": "mouseMov", "alt": "перемещение выбранного - простое перетаскивание (смещение сразу без задержек после нажатия)"}],
    [{"cap": "wait", "alt": "редактирование пункта - долгое нажатие"}]
]        */
    </script>
</body>